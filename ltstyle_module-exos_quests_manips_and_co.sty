%%%% INIT
\newif\ifENONCE
\ENONCEtrue
\newcommand{\enonce}[1]{\ifENONCE #1\par\else\ignorespaces\fi}
\newif\ifCORRIGE
\CORRIGEtrue
\newcommand{\corrige}[1]{\ifCORRIGE \InCorrigeON\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige}\small #1\par\color{tmpcol}\normalsize\InCorrigeOFF\else\ignorespaces\fi}
\newif\ifMINICORRIGE
\MINICORRIGEtrue
\newcommand{\minicorrige}[1]{\ifMINICORRIGE \footnotesize\minicorrquest\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige} #1\normalsize\color{tmpcol}\par\else\ignorespaces\fi}
\newcommand{\minicorrquest}{}
\newcommand{\ifenonce}[1]{\ifENONCE #1\else\ignorespaces\fi}
\newcommand{\ifcorrige}[1]{\ifCORRIGE \InCorrigeON\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige} #1\color{tmpcol}\InCorrigeOFF\else\ignorespaces\fi}
\newcommand{\ifcorrigesimple}[1]{\ifCORRIGE \InCorrigeON #1\InCorrigeOFF\else\ignorespaces\fi}
\newcommand{\ifminicorrige}[1]{\ifMINICORRIGE \protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige}#1\color{tmpcol}\fi}
\newcommand{\ifminicorrigesimple}[1]{\ifMINICORRIGE #1\else\ignorespaces\fi}
\newcommand{\ifnotenonce}[1]{\ifENONCE \ignorespaces\else #1\fi}
\newcommand{\ifnotcorrige}[1]{\ifCORRIGE \ignorespaces\else #1\fi}
\newcommand{\ifnotminicorrige}[1]{\ifMINICORRIGE \ignorespaces\else #1\fi}
\newcommand{\onlyenonce}[1]{\ifnum \ifCORRIGE 1\else\ifMINICORRIGE 1\else 0\fi\fi= 1 \ignorespaces\else\ifenonce{#1}\fi}
\newcommand{\onlyshortenonce}[1]{\ignorespaces}
\newcommand{\onlycorrige}[1]{\ifnum \ifENONCE 1\else\ifMINICORRIGE 1\else 0\fi\fi= 1 \ignorespaces\else\ifcorrige{#1}\fi}
\newcommand{\onlyminicorrige}[1]{\ifnum \ifENONCE 1\else\ifCORRIGE 1\else 0\fi\fi= 1 \ignorespaces\else\ifminicorrige{#1}\fi}

%%%%

\newcounter{equationE}
\newcounter{equationC}
\newcounter{figureE}
\newcounter{figureC}
\newcounter{tableE}
\newcounter{tableC}
\def\InCorrigeMarkerStyle{\underline{C}}
\def\InCorrigeMarker{}
%\let\oldtheequation\theequation
%\def\theequation{\InCorrigeMarker\oldtheequation}
\let\oldthefigure\thefigure
\def\thefigure{\InCorrigeMarker\oldthefigure}
\let\oldthetable\thetable
\def\thetable{\InCorrigeMarker\oldthetable}
\def\InCorrigeON{%
    \def\InCorrigeMarker{\InCorrigeMarkerStyle}%
    %\addtocounter{equationE}{-\arabic{equationE}}%
    %\addtocounter{equationE}{\arabic{equation}}%
    %\addtocounter{equation}{-\arabic{equation}}%
    %\addtocounter{equation}{\arabic{equationC}}%
    \addtocounter{figureE}{-\arabic{figureE}}%
    \addtocounter{figureE}{\arabic{figure}}%
    \addtocounter{figure}{-\arabic{figure}}%
    \addtocounter{figure}{\arabic{figureC}}%
    \addtocounter{tableE}{-\arabic{tableE}}%
    \addtocounter{tableE}{\arabic{table}}%
    \addtocounter{table}{-\arabic{table}}%
    \addtocounter{table}{\arabic{tableC}}%
    }
\def\InCorrigeOFF{%
    \def\InCorrigeMarker{}%
    %\addtocounter{equationC}{-\arabic{equationC}}%
    %\addtocounter{equationC}{\arabic{equation}}%
    %\addtocounter{equation}{-\arabic{equation}}%
    %\addtocounter{equation}{\arabic{equationE}}%
    \addtocounter{figureC}{-\arabic{figureC}}%
    \addtocounter{figureC}{\arabic{figure}}%
    \addtocounter{figure}{-\arabic{figure}}%
    \addtocounter{figure}{\arabic{figureE}}%
    \addtocounter{tableC}{-\arabic{tableC}}%
    \addtocounter{tableC}{\arabic{table}}%
    \addtocounter{table}{-\arabic{table}}%
    \addtocounter{table}{\arabic{tableE}}%
    }

\def\enonceON{\ENONCEtrue}
\def\corrigeON{\CORRIGEtrue}
\def\minicorrigeON{\MINICORRIGEtrue}
\def\enonceOFF{\ENONCEfalse}
\def\corrigeOFF{\CORRIGEfalse}
\def\minicorrigeOFF{\MINICORRIGEfalse}

\enonceON
\corrigeOFF
\minicorrigeOFF

\def\trou#1{\underline{\ifnotcorrige{\vphantom{\huge Àq}\hphantom{\huge #1}}\ifcorrige{#1}}}

\newcommand{\exoappliicone}{\Writinghand}
\newcommand{\todotdicone}{\Pointinghand}
\newcommand{\pgrmicone}{\colorlet{currentcolor}{.}\tikz{
\draw (0,0) coordinate (A);
\draw (A) + (.6em, 0) coordinate (B);
\draw (A) + (-.05em, .15em) coordinate (D);
\draw (B) + (-.05em, .15em) coordinate (C);

\foreach \c in {A,B,C,D}{
\draw (\c) + (.22em, .65em) coordinate (u\c);
}

\draw [currentcolor, line width=.05em, rounded corners = .08em] ($(A)!.5!(B)$) -- (A) -- (D) -- (C) -- (uC) -- (uD) -- (D) -- (A) -- (B) -- (uB);
\draw [currentcolor, line width=.05em, fill, rounded corners = .08em] (D) -- (C) -- (uC) -- (uD) -- cycle;

\foreach \k in {1,...,4}{
\draw ($(uD)!{(\k+1)/10}!(D)$) coordinate (l\k);
\draw ($(uC)!{(\k+1)/10}!(C)$) coordinate (r\k);
\draw ($(l\k)!.2!(r\k)$) coordinate (cl\k);
\draw ($(r\k)!.2!(l\k)$) coordinate (cr\k);
}
\fill [white, rounded corners = .02em] (cl1) -- (cr1) -- (cr2) -- (cl2) -- cycle;
\fill [white, rounded corners = .02em] (cl3) -- (cr3) -- (cr4) -- (cl4) -- cycle;}}

\def\exoMARKERinmargin#1{\strut\vadjust{\kern-\dp\strutbox\llap{\smash{\parbox[c]{\marginparwidth}{\hfill\hfill#1\hfill~}}\kern\marginparsep\vspace{-9.5pt}\vspace{\baselineskip}}}}

\def\todotdcurrentMARKER{}
\def\todotd{\def\todotdcurrentMARKER{\exoMARKERinmargin{\todotdicone}}}
\def\exoappli{\def\todotdcurrentMARKER{\exoMARKERinmargin{\exoappliicone}}}

\newcounter{exopart}
\newcounter{exo}
\newcounter{subexo}[exo]
\newcounter{subsubexo}[subexo]

\input ltstyle_module-exos_quests_manips_and_co-style.sty
\input ltstyle_module-quests.sty
\input ltstyle_module-exos_quests_manips_and_co-style.sty

\input ltstyle_module-manips.sty

\input ltstyle_module-bareme.sty

\makeatletter
\@ifclassloaded{article}{\newcounter{chapter}}{}
\ifthenelse{\equal{\PackageOption}{complet}\or\equal{\PackageOption}{livret}\or\equal{\PackageOption}{TDs}\or\equal{\PackageOption}{TPs}\or\equal{\PackageOption}{book}}
           {\ifthenelse{\equal{\ContinuousExoNumbering}{False}}
             {\@addtoreset{exo}{chapter}}
             {}
           }
           {}
\AtEndPreamble{\ifthenelse{\equal{\ExoResetsCounters}{True}}
           {
             \@addtoreset {equation}{exo}
             \renewcommand \theequation
                           {\@arabic\c@equation}
             \@addtoreset {figure}{exo}
             \renewcommand \thefigure
                           {\ifnum \c@exo>\z@ \theexo.\fi \@arabic\c@figure}
             \@addtoreset {table}{exo}
             \renewcommand \thetable
                           {\ifnum \c@exo>\z@ \theexo.\fi \@arabic\c@table}
           }
           {}}
\makeatother

\newcommand{\exo}[2][Exercice]{\ExoBaremeMake\setcounter{quest}{0}\refstepcounter{exo}
\subsubsection*{\todotdcurrentMARKER #1 \theexo~~~#2\ExoBaremeWrite}\def\todotdcurrentMARKER{}}

\newcommand{\subexo}[2][Exercice]{\refstepcounter{subexo}
\subsubsection*{#1 \thesubexo~~~#2}}

\newcommand{\subsubexo}[2][Exercice]{\refstepcounter{subsubexo}
\subsubsection*{#1 \thesubsubexo~~~#2}}

\def\qdc{\exo[]{Question de cours}}
\def\qdcs{\exo[]{Questions de cours}}

\newcommand{\exocite}[1]{\ \citet{#1}}
\newcommand{\exonocite}[1]{}
\let\origexocite\exocite
\let\origexonocite\exonocite
\renewcommand{\exocite}[1]{\nocite{#1}}

\newif\ifExoSource
\ExoSourcetrue
\AtBeginDocument{
    \ifthenelse{
        \equal{\PackageOption}{DM}\or\equal{\insertshortenseignementtype}{DM}\or\equal{\insertenseignementtype}{DM}
        \or
        \(\(\equal{\PackageOption}{DS}\or\equal{\insertshortenseignementtype}{DS}\or\equal{\insertenseignementtype}{DS}\)\and\(\not\equal{\classelvl}{SPE}\)\)
    }{
        \ifnotcorrige{\ExoSourcefalse}
    }{}
}

\newcommand{\exofrom}[3][]{% concours/examens avec années, filières, option additionnelle
    #2%
    \ifthenelse{\equal{#2}{}\or\equal{#3}{}}{}{ -- }%
    #3%
    \ifthenelse{\equal{#1}{}}{}{ -- }%
    #1%
    }
\newcommand{\exoextract}[3][]{\ifExoSource\ (\exofrom[#1]{#2}{#3})\fi}
\newcommand{\exoinspire}[3][]{\ifExoSource\ (d'après \exofrom[#1]{#2}{#3})\fi}

\ifthenelse{\equal{\PackageOption}{DS}\or\equal{\PackageOption}{controle}\or\equal{\PackageOption}{DM}\or\equal{\PackageOption}{corrige}}{
  \ifthenelse{\equal{\PackageOption}{corrige}}{\enonceOFF\corrigeON}{\enonceON\corrigeOFF}
  \ifthenelse{\equal{\isbeamer}{true}}{}{\input ltqueststyle-default.sty}
}{}

\newif\ifListeExoCours
\def\inputexosfilename{liste-exos_de_cours.tex}
\AtEndPreamble{\newwrite\inputexosfile}
\AtEndPreamble{\ifthenelse{\equal{\PackageOption}{chapter}\or\equal{\PackageOption}{complet}}{\ListeExoCourstrue}{\ListeExoCoursfalse}}
\AtBeginDocument{\ifListeExoCours\immediate\openout\inputexosfile=\inputexosfilename\fi}
\AtEndDocument{\AtEndDocument{\ifListeExoCours\immediate\closeout\inputexosfile\fi}}
\def\inputexoappli#1{\exoappli\input{#1}}
\newcommand{\inputexo}[2][Exercice d'application]{{%
    \refstepcounter{exo}%
    \ifListeExoCours\immediate\write\inputexosfile{inputexoappli{#2}}\fi
    \def\remarquemarker{\exoappliicone}%
    \renewcommand{\exo}[2][]{##2\endinput}%
    \remarque[\ltcolorthemeC][#1 \theexo]{%
        \input{#2}}
        }}
\newcommand{\Pgrmitem}[2][]{{%
    \def\remarquemarker{\pgrmicone}%
    \remarque[\ltcolorthemeB][#1]{\sffamily #2}
    }}
\newcommand{\pgrmitem}[2][]{{%
    {\color{ltcolor\ltcolorthemeB}{\pgrmicone}} \textbf{#1}\ifthenelse{\equal{#1}{}}{}{\quad}\textsl{\sffamily #2}
    }}
