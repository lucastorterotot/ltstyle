%%%% INIT
\newcommand{\enonce}[1]{}
\newcommand{\corrige}[1]{}
\newcommand{\minicorrige}[1]{}
\newcommand{\minicorrquest}{}
\newcommand{\ifenonce}[1]{}
\newcommand{\ifcorrige}[1]{}
\newcommand{\ifcorrigesimple}[1]{}
\newcommand{\ifminicorrige}[1]{}
\newcommand{\ifminicorrigesimple}[1]{}
\newcommand{\ifnotenonce}[1]{}
\newcommand{\ifnotcorrige}[1]{}
\newcommand{\ifnotminicorrige}[1]{}
\newcommand{\onlyenonce}[1]{}
\newcommand{\onlyshortenonce}[1]{\ignorespaces}
\newcommand{\onlycorrige}[1]{}
\newcommand{\onlyminicorrige}[1]{}

%%%%

\newcounter{equationE}
\newcounter{equationC}
\newcounter{figureE}
\newcounter{figureC}
\newcounter{tableE}
\newcounter{tableC}
\def\InCorrigeMarkerStyle{\underline{C}}
\def\InCorrigeMarker{}
%\let\oldtheequation\theequation
%\def\theequation{\InCorrigeMarker\oldtheequation}
\let\oldthefigure\thefigure
\def\thefigure{\InCorrigeMarker\oldthefigure}
\let\oldthetable\thetable
\def\thetable{\InCorrigeMarker\oldthetable}
\def\InCorrigeON{%
    \def\InCorrigeMarker{\InCorrigeMarkerStyle}%
    %\addtocounter{equationE}{-\arabic{equationE}}%
    %\addtocounter{equationE}{\arabic{equation}}%
    %\addtocounter{equation}{-\arabic{equation}}%
    %\addtocounter{equation}{\arabic{equationC}}%
    \addtocounter{figureE}{-\arabic{figureE}}%
    \addtocounter{figureE}{\arabic{figure}}%
    \addtocounter{figure}{-\arabic{figure}}%
    \addtocounter{figure}{\arabic{figureC}}%
    \addtocounter{tableE}{-\arabic{tableE}}%
    \addtocounter{tableE}{\arabic{table}}%
    \addtocounter{table}{-\arabic{table}}%
    \addtocounter{table}{\arabic{tableC}}%
    }
\def\InCorrigeOFF{%
    \def\InCorrigeMarker{}%
    %\addtocounter{equationC}{-\arabic{equationC}}%
    %\addtocounter{equationC}{\arabic{equation}}%
    %\addtocounter{equation}{-\arabic{equation}}%
    %\addtocounter{equation}{\arabic{equationE}}%
    \addtocounter{figureC}{-\arabic{figureC}}%
    \addtocounter{figureC}{\arabic{figure}}%
    \addtocounter{figure}{-\arabic{figure}}%
    \addtocounter{figure}{\arabic{figureE}}%
    \addtocounter{tableC}{-\arabic{tableC}}%
    \addtocounter{tableC}{\arabic{table}}%
    \addtocounter{table}{-\arabic{table}}%
    \addtocounter{table}{\arabic{tableE}}%
    }

\def\enonceON{%
  \renewcommand{\enonce}[1]{##1\par}%
  \renewcommand{\ifenonce}[1]{##1}%
  \renewcommand{\ifnotenonce}[1]{\ignorespaces}%
  \renewcommand{\onlycorrige}[1]{\ignorespaces}%
}
\def\corrigeON{%
  \renewcommand{\corrige}[1]{\InCorrigeON\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige}\small ##1\par\color{tmpcol}\normalsize\InCorrigeOFF}%
  \renewcommand{\ifcorrige}[1]{\InCorrigeON\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige} ##1\color{tmpcol}\InCorrigeOFF}%
  \renewcommand{\ifcorrigesimple}[1]{\InCorrigeON ##1\InCorrigeOFF}%
  \renewcommand{\ifnotcorrige}[1]{\ignorespaces}%
  \renewcommand{\onlyenonce}[1]{\ignorespaces}%
}
\def\minicorrigeON{%
  \renewcommand{\minicorrige}[1]{\footnotesize\minicorrquest\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige} ##1\normalsize\color{tmpcol}\par}%
  \renewcommand{\ifminicorrige}[1]{\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige}##1\color{tmpcol}}%
  \renewcommand{\ifminicorrigesimple}[1]{##1}%
  \renewcommand{\ifnotminicorrige}[1]{\ignorespaces}%
  \renewcommand{\onlyenonce}[1]{\ignorespaces}%
}
\def\enonceOFF{%
  \renewcommand{\enonce}[1]{\ignorespaces}%
  \renewcommand{\ifenonce}[1]{\ignorespaces}%
  \renewcommand{\ifnotenonce}[1]{##1}%
  \renewcommand{\onlycorrige}[1]{\ifcorrige{##1}}%
}
\def\corrigeOFF{%
  \renewcommand{\corrige}[1]{\ignorespaces}%
  \renewcommand{\ifcorrige}[1]{\ignorespaces}%
  \renewcommand{\ifcorrigesimple}[1]{\ignorespaces}%
  \renewcommand{\ifnotcorrige}[1]{##1}%
  \renewcommand{\onlyenonce}[1]{\ifenonce{##1}}%
}
\def\minicorrigeOFF{%
  \renewcommand{\minicorrige}[1]{\ignorespaces}%
  \renewcommand{\ifminicorrige}[1]{\ignorespaces}%
  \renewcommand{\ifminicorrigesimple}[1]{\ignorespaces}%
  \renewcommand{\ifnotminicorrige}[1]{##1}%
  \renewcommand{\onlyenonce}[1]{\ifenonce{##1}}%
}

\enonceON
\corrigeOFF
\minicorrigeOFF

\def\trou#1{\underline{\ifnotcorrige{\vphantom{\huge Àq}\hphantom{\huge #1}}\ifcorrige{#1}}}

\newcommand{\exoappliicone}{\Writinghand}
\newcommand{\todotdicone}{\Pointinghand}
\newcommand{\pgrmicone}{\colorlet{currentcolor}{.}\tikz{
\draw (0,0) coordinate (A);
\draw (A) + (.5em, 0) coordinate (B);
\draw (A) + (-.04em, .13em) coordinate (D);
\draw (B) + (-.04em, .13em) coordinate (C);

\foreach \c in {A,B,C,D}{
\draw (\c) + (.18em, .53em) coordinate (u\c);
}

\draw [currentcolor, line width=.04em, rounded corners = .07em] ($(A)!.5!(B)$) -- (A) -- (D) -- (C) -- (uC) -- (uD) -- (D) -- (A) -- (B) -- (uB);
\draw [currentcolor, line width=.04em, fill, rounded corners = .07em] (D) -- (C) -- (uC) -- (uD) -- cycle;

\foreach \k in {1,...,4}{
\draw ($(uD)!{(\k+1)/10}!(D)$) coordinate (l\k);
\draw ($(uC)!{(\k+1)/10}!(C)$) coordinate (r\k);
\draw ($(l\k)!.2!(r\k)$) coordinate (cl\k);
\draw ($(r\k)!.2!(l\k)$) coordinate (cr\k);
}
\fill [white, rounded corners = .01em] (cl1) -- (cr1) -- (cr2) -- (cl2) -- cycle;
\fill [white, rounded corners = .01em] (cl3) -- (cr3) -- (cr4) -- (cl4) -- cycle;}}

\newcommand{\Sicone}{\colorlet{currentcolor}{.}\tikz{% savoir
\draw (0,0) coordinate (A);
\draw (A) + (-70:.23em) coordinate (B) ;
\draw (B) + (-90:.23em) coordinate (C) ;
\draw (A) + (250:.23em) coordinate (D) ;
\draw (D) + (-90:.23em) coordinate (E) ;
\fill let \p1=(A) in let \p2=(B) in [ltcolorgray2, rounded corners = .07em] (E) rectangle (\x2, \y1);
\fill [ltcoloryellow2] (A) circle (.23em);
\draw [black, line width=.04em, rounded corners = .07em] ($(C)!.5!(B)$) -- (B) arc (-70:90:.23em);
\draw [black, line width=.04em, rounded corners = .07em] ($(C)!.5!(B)$) -- (C) -- (E) -- (D) arc (250:90:.23em);
\foreach \k in {1,...,3}{
    \draw ($(B)!{(\k-.75)/4}!(C)$) -- ($(D)!{(\k+.25)/4}!(E)$);
}
\draw (B) --+ (80:.23em) coordinate (rB);
\draw (D) --+ (100:.23em) coordinate (rD);
\draw [decoration={aspect=.3, segment length=.079em, amplitude=.063em, coil},decorate] (rD) -- (rB);
}}

\def\drawrouedentee#1#2#3#4#5#6#7{% coordinate / r in / r out / N / delta theta in / delta theta out / theta0
    \foreach \k in {1,...,#4}{
        \draw (#1) ++ ({#7 + (\k-1)/#4*360 - #5/2}:{#2}) coordinate (d1);
        \draw (#1) ++ ({#7 + (\k-1)/#4*360 - #6/2}:{#3}) coordinate (d2);
        \draw (#1) ++ ({#7 + (\k-1)/#4*360 + #6/2}:{#3}) coordinate (d3);
        \draw (#1) ++ ({#7 + (\k-1)/#4*360 + #5/2}:{#2}) coordinate (d4);
        \fill [currentcolor] (d1)
            -- (d2) arc ({#7 + (\k-1)/#4*360 - #6/2}:{#7 + (\k-1)/#4*360 + #6/2}:{#3})
            -- (d4) arc ({#7 + (\k-1)/#4*360 + #5/2}:{#7 + (\k-1)/#4*360 - #5/2}:{#2})
            -- cycle;
    }
    \fill [currentcolor] (#1) circle (#2);
}

\newcommand{\SFicone}{\colorlet{currentcolor}{.}\tikz{% savoir
\draw (0,0) coordinate (r1);
\draw (r1) + (-28:.45em) coordinate (r2) ;
\drawrouedentee{r1}{.22em}{.27em}{8}{25}{12}{29}
\drawrouedentee{r2}{.18em}{.23em}{7}{30}{15}{12}
\fill [white] (r1) circle (.11em);
\fill [white] (r2) circle (.08em);
}}

\def\Micone{{\boldmath\ensuremath{\pi}}}

\def\exoMARKERinmargin#1{\strut\vadjust{\kern-\dp\strutbox\llap{\smash{\parbox[c]{\marginparwidth}{\hfill\hfill#1\hfill~}}\kern\marginparsep\vspace{-9.5pt}\vspace{\baselineskip}}}}

\def\todotdcurrentMARKER{}
\def\todotd{\def\todotdcurrentMARKER{\exoMARKERinmargin{\todotdicone}}}
\def\exoappli{\def\todotdcurrentMARKER{\exoMARKERinmargin{\exoappliicone}}}

\newcounter{exopart}
\newcounter{exo}
\newcounter{subexo}[exo]
\newcounter{subsubexo}[subexo]

\input ltstyle_module-exos_quests_manips_and_co-style.sty
\input ltstyle_module-quests.sty
\input ltstyle_module-exos_quests_manips_and_co-style.sty

\input ltstyle_module-manips.sty

\input ltstyle_module-bareme.sty

\makeatletter
\@ifclassloaded{article}{\newcounter{chapter}}{}
\ifthenelse{\equal{\PackageOption}{complet}\or\equal{\PackageOption}{livret}\or\equal{\PackageOption}{TDs}\or\equal{\PackageOption}{TPs}\or\equal{\PackageOption}{book}}
           {\ifthenelse{\equal{\ContinuousExoNumbering}{False}}
             {\@addtoreset{exo}{chapter}}
             {}
           }
           {}
\AtEndPreamble{\ifthenelse{\equal{\ExoResetsCounters}{True}}
           {
             \@addtoreset {equation}{exo}
             \renewcommand \theequation
                           {\@arabic\c@equation}
             \@addtoreset {figure}{exo}
             \renewcommand \thefigure
                           {\ifnum \c@exo>\z@ \theexo.\fi \@arabic\c@figure}
             \@addtoreset {table}{exo}
             \renewcommand \thetable
                           {\ifnum \c@exo>\z@ \theexo.\fi \@arabic\c@table}
           }
           {}}
\makeatother

\newcommand{\exo}[2][Exercice]{\ExoBaremeMake\setcounter{quest}{0}\refstepcounter{exo}
\subsubsection*{\todotdcurrentMARKER #1 \theexo~~~#2\ExoBaremeWrite}\def\todotdcurrentMARKER{}}

\newcommand{\subexo}[2][Exercice]{\refstepcounter{subexo}
\subsubsection*{#1 \thesubexo~~~#2}}

\newcommand{\subsubexo}[2][Exercice]{\refstepcounter{subsubexo}
\subsubsection*{#1 \thesubsubexo~~~#2}}

\def\qdc{\exo[]{Question de cours}}
\def\qdcs{\exo[]{Questions de cours}}

\newcommand{\exocite}[1]{\ \citet{#1}}
\newcommand{\exonocite}[1]{}
\let\origexocite\exocite
\let\origexonocite\exonocite
\renewcommand{\exocite}[1]{\nocite{#1}}

\newif\ifExoSource
\ExoSourcetrue
\AtBeginDocument{
    \ifthenelse{
        \equal{\PackageOption}{DM}\or\equal{\insertshortenseignementtype}{DM}\or\equal{\insertenseignementtype}{DM}
        \or
        \(\(\equal{\PackageOption}{DS}\or\equal{\insertshortenseignementtype}{DS}\or\equal{\insertenseignementtype}{DS}\)\and\(\not\equal{\classelvl}{SPE}\)\)
    }{
        \ifnotcorrige{\ExoSourcefalse}
    }{}
}

\newcommand{\exofrom}[3][]{% concours/examens avec années, filières, option additionnelle
    #2%
    \ifthenelse{\equal{#2}{}\or\equal{#3}{}}{}{ -- }%
    #3%
    \ifthenelse{\equal{#1}{}}{}{ -- }%
    #1%
    }
\newcommand{\exoextract}[3][]{\ifExoSource\ (\exofrom[#1]{#2}{#3})\fi}
\newcommand{\exoinspire}[3][]{\ifExoSource\ (d'après \exofrom[#1]{#2}{#3})\fi}

\ifthenelse{\equal{\PackageOption}{DS}\or\equal{\PackageOption}{controle}\or\equal{\PackageOption}{DM}\or\equal{\PackageOption}{corrige}}{
  \ifthenelse{\equal{\PackageOption}{corrige}}{\enonceOFF\corrigeON}{\enonceON\corrigeOFF}
  \ifthenelse{\equal{\isbeamer}{true}}{}{\input ltqueststyle-default.sty}
}{}

\newif\ifListeExoCours
\def\inputexosfilename{liste-exos_de_cours.tex}
\AtEndPreamble{\newwrite\inputexosfile}
\AtEndPreamble{\ifthenelse{\equal{\PackageOption}{chapter}\or\equal{\PackageOption}{complet}}{\ListeExoCourstrue}{\ListeExoCoursfalse}}
\AtBeginDocument{\ifListeExoCours\immediate\openout\inputexosfile=\inputexosfilename\fi}
\AtEndDocument{\AtEndDocument{\ifListeExoCours\immediate\closeout\inputexosfile\fi}}
\def\inputexoappli#1{\exoappli\input{#1}}
\newcommand{\inputexo}[2][Exercice d'application]{{%
    \refstepcounter{exo}%
    \ifListeExoCours\immediate\write\inputexosfile{inputexoappli{#2}}\fi
    \def\remarquemarker{\exoappliicone}%
    \renewcommand{\exo}[2][]{##2\endinput}%
    \remarque[\ltcolorthemeC][#1 \theexo]{%
        \input{#2}}
        }}
\newcommand{\Pgrmitem}[2][]{{%
    \def\remarquemarker{\pgrmicone}%
    \remarque[\ltcolorthemeB][#1]{\sffamily #2}
    }}
\newcommand{\pgrmitem}[2][]{{%
    {\color{ltcolor\ltcolorthemeB}{\pgrmicone}} \textbf{#1}\ifthenelse{\equal{#1}{}}{}{\quad}\textsl{\sffamily #2}
    }}
