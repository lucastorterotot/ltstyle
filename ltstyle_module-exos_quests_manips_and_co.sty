%%%% INIT
\newcommand{\enonce}[1]{}
\newcommand{\corrige}[1]{}
\newcommand{\minicorrige}[1]{}
\newcommand{\minicorrquest}{}
\newcommand{\ifenonce}[1]{}
\newcommand{\ifcorrige}[1]{}
\newcommand{\ifcorrigesimple}[1]{}
\newcommand{\ifminicorrige}[1]{}
\newcommand{\ifminicorrigesimple}[1]{}
\newcommand{\ifnotenonce}[1]{}
\newcommand{\ifnotcorrige}[1]{}
\newcommand{\ifnotminicorrige}[1]{}
\newcommand{\onlyenonce}[1]{}
\newcommand{\onlyshortenonce}[1]{\ignorespaces}
\newcommand{\onlycorrige}[1]{}
\newcommand{\onlyminicorrige}[1]{}

%%%%

\def\enonceON{%
  \renewcommand{\enonce}[1]{##1\par}%
  \renewcommand{\ifenonce}[1]{##1}%
  \renewcommand{\ifnotenonce}[1]{\ignorespaces}%
  \renewcommand{\onlycorrige}[1]{\ignorespaces}%
}
\def\corrigeON{%
  \renewcommand{\corrige}[1]{\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige}\small ##1\par\color{tmpcol}\normalsize}%
  \renewcommand{\ifcorrige}[1]{\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige}##1\color{tmpcol}}%
  \renewcommand{\ifcorrigesimple}[1]{##1}%
  \renewcommand{\ifnotcorrige}[1]{\ignorespaces}%
  \renewcommand{\onlyenonce}[1]{\ignorespaces}%
}
\def\minicorrigeON{%
  \renewcommand{\minicorrige}[1]{\footnotesize\minicorrquest\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige} ##1\normalsize\color{tmpcol}\par}%
  \renewcommand{\ifminicorrige}[1]{\protect\colorlet{tmpcol}{.}\color{\ltcolorcorrige}##1\color{tmpcol}}%
  \renewcommand{\ifminicorrigesimple}[1]{##1}%
  \renewcommand{\ifnotminicorrige}[1]{\ignorespaces}%
  \renewcommand{\onlyenonce}[1]{\ignorespaces}%
}
\def\corrigeONblue{\corrigeON}
\def\enonceOFF{%
  \renewcommand{\enonce}[1]{\ignorespaces}%
  \renewcommand{\ifenonce}[1]{\ignorespaces}%
  \renewcommand{\ifnotenonce}[1]{##1}%
  \renewcommand{\onlycorrige}[1]{\ifcorrige{##1}}%
}
\def\corrigeOFF{%
  \renewcommand{\corrige}[1]{\ignorespaces}%
  \renewcommand{\ifcorrige}[1]{\ignorespaces}%
  \renewcommand{\ifcorrigesimple}[1]{\ignorespaces}%
  \renewcommand{\ifnotcorrige}[1]{##1}%
  \renewcommand{\onlyenonce}[1]{\ifenonce{##1}}%
}
\def\minicorrigeOFF{%
  \renewcommand{\minicorrige}[1]{\ignorespaces}%
  \renewcommand{\ifminicorrige}[1]{\ignorespaces}%
  \renewcommand{\ifminicorrigesimple}[1]{\ignorespaces}%
  \renewcommand{\ifnotminicorrige}[1]{##1}%
  \renewcommand{\onlyenonce}[1]{\ifenonce{##1}}%
}

\enonceON
\corrigeOFF
\minicorrigeOFF

\newcommand{\exoappliicone}{\Writinghand}
\newcommand{\todotdicone}{\Pointinghand}

\def\exoMARKERinmargin#1{\strut\vadjust{\kern-\dp\strutbox\llap{\smash{\parbox[c]{\marginparwidth}{\hfill\hfill#1\hfill~}}\kern\marginparsep\vspace{-9.5pt}\vspace{\baselineskip}}}}

\def\todotdcurrentMARKER{}
\def\todotd{\def\todotdcurrentMARKER{\exoMARKERinmargin{\todotdicone}}}
\def\exoappli{\def\todotdcurrentMARKER{\exoMARKERinmargin{\exoappliicone}}}

\newcounter{exopart}
\newcounter{exo}
\newcounter{subexo}[exo]
\newcounter{subsubexo}[subexo]

\input ltstyle_module-exos_quests_manips_and_co-style.sty
\input ltstyle_module-quests.sty
\input ltstyle_module-exos_quests_manips_and_co-style.sty

\input ltstyle_module-manips.sty

\input ltstyle_module-bareme.sty

\makeatletter
\@ifclassloaded{article}{\newcounter{chapter}}{}
\ifthenelse{\equal{\PackageOption}{complet}\or\equal{\PackageOption}{livret}\or\equal{\PackageOption}{TDs}\or\equal{\PackageOption}{TPs}\or\equal{\PackageOption}{book}}
           {\ifthenelse{\equal{\ContinuousExoNumbering}{False}}
             {\@addtoreset{exo}{chapter}}
             {}
           }
           {}
\AtEndPreamble{\ifthenelse{\equal{\ExoResetsCounters}{True}}
           {
             \@addtoreset {equation}{exo}
             \renewcommand \theequation
                           {\@arabic\c@equation}
             \@addtoreset {figure}{exo}
             \renewcommand \thefigure
                           {\ifnum \c@exo>\z@ \theexo.\fi \@arabic\c@figure}
             \@addtoreset {table}{exo}
             \renewcommand \thetable
                           {\ifnum \c@exo>\z@ \theexo.\fi \@arabic\c@table}
           }
           {}}
\makeatother

\newcommand{\exo}[2][Exercice]{\ExoBaremeMake\setcounter{quest}{0}\refstepcounter{exo}
\subsubsection*{\todotdcurrentMARKER #1 \theexo~~~#2\ExoBaremeWrite}\def\todotdcurrentMARKER{}}

\newcommand{\subexo}[2][Exercice]{\refstepcounter{subexo}
\subsubsection*{#1 \thesubexo~~~#2}}

\newcommand{\subsubexo}[2][Exercice]{\refstepcounter{subsubexo}
\subsubsection*{#1 \thesubsubexo~~~#2}}

\def\qdc{\exo[]{Question de cours}}
\def\qdcs{\exo[]{Questions de cours}}

\newcommand{\exocite}[1]{\ \citet{#1}}
\newcommand{\exonocite}[1]{}
\let\origexocite\exocite
\let\origexonocite\exonocite
\renewcommand{\exocite}[1]{\nocite{#1}}

\newif\ifExoSource
\ExoSourcetrue
\AtBeginDocument{
    \ifthenelse{
        \equal{\PackageOption}{DM}\or\equal{\insertshortenseignementtype}{DM}\or\equal{\insertenseignementtype}{DM}
    }{
        \ifnotcorrige{\ExoSourcefalse}
    }{}
}

\newcommand{\exofrom}[3][]{% concours/examens avec années, filières, option additionnelle
    #2%
    \ifthenelse{\equal{#2}{}\or\equal{#3}{}}{}{ -- }%
    #3%
    \ifthenelse{\equal{#1}{}}{}{ -- }%
    #1%
    }
\newcommand{\exoextract}[3][]{\ifExoSource\ (\exofrom[#1]{#2}{#3})\fi}
\newcommand{\exoinspire}[3][]{\ifExoSource\ (d'après \exofrom[#1]{#2}{#3})\fi}

\ifthenelse{\equal{\PackageOption}{DS}\or\equal{\PackageOption}{controle}\or\equal{\PackageOption}{DM}\or\equal{\PackageOption}{corrige}}{
  \ifthenelse{\equal{\PackageOption}{corrige}}{\enonceOFF\corrigeON}{\enonceON\corrigeOFF}
  \ifthenelse{\equal{\isbeamer}{true}}{}{\input ltqueststyle-default.sty}
}{}

\newif\ifListeExoCours
\def\inputexosfilename{liste-exos_de_cours.tex}
\AtEndPreamble{\newwrite\inputexosfile}
\AtEndPreamble{\ifthenelse{\equal{\PackageOption}{chapter}\or\equal{\PackageOption}{complet}}{\ListeExoCourstrue}{\ListeExoCoursfalse}}
\AtBeginDocument{\ifListeExoCours\immediate\openout\inputexosfile=\inputexosfilename\fi}
\AtEndDocument{\AtEndDocument{\ifListeExoCours\immediate\closeout\inputexosfile\fi}}
\def\inputexoappli#1{\exoappli\input{#1}}
\newcommand{\inputexo}[2][Exercice d'application]{{%
    \refstepcounter{exo}%
    \ifListeExoCours\immediate\write\inputexosfile{inputexoappli{#2}}\fi
    \def\remarquemarker{\exoappliicone}%
    \renewcommand{\exo}[2][]{##2\endinput}%
    \remarque[\ltcolorthemeC][#1 \theexo]{%
        \input{#2}}
        }}
