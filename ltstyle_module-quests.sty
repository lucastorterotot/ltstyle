\newcounter{quest}
\newcounter{questTemp}
\newcounter{subquest}[quest]
\newcounter{subsubquest}[subquest]
\newcounter{subsubsubquest}[subsubquest]
\newcommand{\rememberquestcount}{\setcounter{quest}{\arabic{questTemp}}}
\newcommand{\savequestcount}{\setcounter{questTemp}{\arabic{quest}}}

\def\questpar{\questspar}
\def\questskip{\questsskip}
\def\questindent{\questsindent}
\def\questbox{\questsbox}
\def\questnum{\questsnum}

\def\questsmarksreset{%
\def\questsmark##1{##1}%
\def\questmark{\questskip\questpar\noindent\questindent{\questshape{\normalsize\questseries\questbox\queststart\questnum\questend}}\questspace}%
\def\questspace{\ }%
}
\questsmarksreset

% d : default ; e : uniquement enonce ; c : uniquement corrige ; a : numÃ©roter le tout % i : invisible
% a
\newcommand{\questsmarksset}[1]{%
\renewcommand{\questsmark}[1]{##1}%
\ifthenelse{\equal{#1}{i}}{\renewcommand{\questsmark}[1]{\ignorespaces}}{}%
\ifthenelse{\equal{#1}{e}\and\equal{\enonce{a}}{\ignorespaces}}{\renewcommand{\questsmark}[1]{}}{}%
\ifthenelse{\equal{#1}{c}\and\equal{\corrige{a}}{\ignorespaces}}{\renewcommand{\questsmark}[1]{}}{}%
\ifthenelse{\equal{#1}{a}}{\def\questindent{\questsindent}%
\ifthenelse{\equal{\arabic{subquest}}{0}}{\questsmarksset{d}}{
\ifthenelse{\equal{\arabic{subsubquest}}{0}}{\def\questskip{\subquestsskip}\def\questbox{\subquestsbox}\def\questnum{{\def\questend{}\def\queststart{}\thesubquest}}}
{\ifthenelse{\equal{\arabic{subsubsubquest}}{0}}{\def\questskip{\subsubquestsskip}\def\questbox{\subsubquestsbox}\def\questnum{{\def\questend{}\def\queststart{}\thesubsubquest}}}
{\def\questskip{\subsubsubquestsskip}\def\questbox{\subsubsubquestsbox}\def\questnum{{\def\questend{}\def\queststart{}\thesubsubsubquest}}}}%
}}{}%
\ifthenelse{\equal{#1}{p}}{%
\ifthenelse{\equal{\arabic{subquest}}{0}}{\questsmarksset{d}}{
\ifthenelse{\equal{\arabic{subsubquest}}{0}}{\def\questskip{\subquestsskip}\def\questindent{\questsindent}\def\questbox{\subquestsbox}\def\questnum{\questsnum\questprevioussep\numsubquest}}
{\ifthenelse{\equal{\arabic{subsubsubquest}}{0}}{\def\questskip{\subsubquestsskip}\def\questindent{\subquestsindent}\def\questbox{\subsubquestsbox}\def\questnum{\subquestsnum\questprevioussep\numsubsubquest}}
{\def\questskip{\subsubsubquestsskip}\def\questindent{\subsubquestsindent}\def\questbox{\subsubsubquestsbox}\def\questnum{\subsubquestsnum\questprevioussep\numsubsubsubquest}}}%
}}{}%
\ifthenelse{\equal{#1}{ea}}{\questsmarksset{a}\questsmarksset{e}}{}%
\ifthenelse{\equal{#1}{ca}}{\questsmarksset{a}\questsmarksset{c}}{}%
\ifthenelse{\equal{#1}{ae}\and\equal{\corrige{a}}{\ignorespaces}}{\questsmarksset{a}}{}%
\ifthenelse{\equal{#1}{ac}\and\equal{\enonce{a}}{\ignorespaces}}{\questsmarksset{a}}{}%
\ifthenelse{\equal{#1}{ep}}{\questsmarksset{p}\questsmarksset{e}}{}%
\ifthenelse{\equal{#1}{cp}}{\questsmarksset{p}\questsmarksset{c}}{}%
\ifthenelse{\equal{#1}{pe}\and\equal{\corrige{a}}{\ignorespaces}}{\questsmarksset{p}}{}%
\ifthenelse{\equal{#1}{pc}\and\equal{\enonce{a}}{\ignorespaces}}{\questsmarksset{p}}{}%
\ifthenelse{\equal{#1}{d}}{}{\def\questspace{}}{}%
}

\newcommand{\quest}[1][d]{%
\def\questpar{\questspar}%
\def\questskip{\questsskip}%
\def\questindent{\questsindent}%
\def\questbox{\questsbox}%
\def\questnum{\questsnum}%
\refstepcounter{quest}%
\questsmarksset{#1}\questsmark{\questmark}\questsmarksreset}
\newcommand{\subquest}[1][d]{%
\def\questpar{\subquestspar}%
\def\questskip{\subquestsskip}%
\def\questindent{\subquestsindent}%
\def\questbox{\subquestsbox}%
\def\questnum{\subquestsnum}%
\refstepcounter{subquest}%
\questsmarksset{#1}\questsmark{\questmark}\questsmarksreset}
\newcommand{\subsubquest}[1][d]{%
\def\questpar{\subsubquestspar}%
\def\questskip{\subsubquestsskip}%
\def\questindent{\subsubquestsindent}%
\def\questbox{\subsubquestsbox}%
\def\questnum{\subsubquestsnum}%
\refstepcounter{subsubquest}%
\questsmarksset{#1}\questsmark{\questmark}\questsmarksreset}
\newcommand{\subsubsubquest}[1][d]{%
\def\questpar{\subsubsubquestspar}%
\def\questskip{\subsubsubquestsskip}%
\def\questindent{\subsubsubquestsindent}%
\def\questbox{\subsubsubquestsbox}%
\def\questnum{\subsubsubquestsnum}%
\refstepcounter{subsubsubquest}%
\questsmarksset{#1}\questsmark{\questmark}\questsmarksreset}
